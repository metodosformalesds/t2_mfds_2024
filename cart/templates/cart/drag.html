{% extends "base_without_image.html" %}
{% load static %}

{% block title %}
    Cargar Archivo Excel
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/custom_style.css' %}">
{% endblock %}

{% block content %}
<main class="container py-5">
  <h2 class="mb-3">Cargar Archivo Excel</h2>
  <p class="text-muted">Arrastra y suelta tu archivo Excel aquí o haz clic para seleccionarlo.</p>

  <!-- Área de carga de archivo Excel -->
  <div id="dropzone" class="border p-5 text-center" onclick="document.getElementById('fileInput').click()" style="cursor: pointer;">
      <p id="dropzone-text" class="mb-0">Arrastra y suelta el archivo aquí o haz clic para seleccionar</p>
  </div>
  <input type="file" id="fileInput" name="file" accept=".xlsx, .xls" style="display: none;">
  
  <!-- Asegúrate de incluir el token CSRF en el HTML -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!-- Mensaje de estado -->
  <p id="status" class="mt-3 text-muted"></p>
  <!-- Contenedor para mostrar la lista de datos -->
  <div id="data-container" class="mt-3"></div>

  <script>
    document.getElementById("dropzone").addEventListener("click", () => {
        document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", handleFile);

    function handleFile(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById("dropzone-text").textContent = `Archivo seleccionado: ${file.name}`;
        }

        const formData = new FormData();
        formData.append("file", file);

        fetch("{% url 'drag_and_drop' %}", {
            method: "POST",
            body: formData,
            headers: { 
                "X-CSRFToken": getCsrfToken() 
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Error en la respuesta del servidor");
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById("status").textContent = "Archivo procesado con éxito.";
                
                // Mostrar la lista de datos en el contenedor
                const dataContainer = document.getElementById("data-container");
                let listHTML = "<h4>Datos del Archivo Excel:</h4><ul>";
                data.data.forEach(row => {
                    listHTML += `<li>${row.join(', ')}</li>`;
                });
                listHTML += "</ul>";

                dataContainer.innerHTML = listHTML;
            } else {
                document.getElementById("status").textContent = `Hubo un error al procesar el archivo: ${data.error}`;
            }
        })
        .catch(error => {
            document.getElementById("status").textContent = "Error al cargar el archivo.";
            console.error("Error:", error);
        });
    }

    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            return csrfInput.value;
        } else {
            console.error("No se pudo encontrar el token CSRF en la página.");
            return "";
        }
    }
  </script>
</main>
{% endblock %}
