{% extends "base_without_image.html" %}
{% load static %}

{% block title %}
    Solid steel - recycle
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/style_recycler.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #map {
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }
    </style>
{% endblock %}

{% block content %}
<main class="container py-5">
  <h2 class="mb-3">Recicladoras Cercanas</h2>
  <p class="text-muted">¡Estamos buscando las recicladoras más cercanas a tu ubicación!</p>

  <!-- Modal -->
  <div class="modal fade" id="companyInfoModal" tabindex="-1" aria-labelledby="companyInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="companyInfoModalLabel">Información de la Empresa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h5 id="companyName">Nombre de la Empresa</h5>
            <p id="companyDescription">Descripción de la empresa aquí...</p>
            <p id="companyLocation">Ubicación: </p>
            <div id="map"></div> <!-- Contenedor para el mapa de Google Maps -->
          </div>
        </div>
      </div>
  </div>

  <!-- Contenedor para las tarjetas de las empresas recicladoras -->
  <div class="recycler-list row g-0" id="recycler-list"></div>

  <!-- Botón para cargar más recicladoras -->
  <div class="text-center mt-4">
      <button id="load-more-btn" class="btn btn-primary">Ver más</button>
  </div>

  <script>
      let map;
      let service;
      let geocoder;
      let currentResults = []; // Almacena todos los resultados
      let resultsIndex = 0; // Índice de la posición actual en los resultados
      const resultsPerPage = 5; // Número de recicladoras que se mostrarán por carga

      // Inicializar el mapa de Google Maps
      function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
              zoom: 12,
              center: { lat: 31.6904, lng: -106.4245 } // Coordenadas por defecto
          });
          geocoder = new google.maps.Geocoder();

          // Obtener la ubicación del usuario
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                  (position) => {
                      const userLocation = {
                          lat: position.coords.latitude,
                          lng: position.coords.longitude
                      };
                      map.setCenter(userLocation);
                      buscarRecicladorasCercanas(userLocation);
                  },
                  () => {
                      alert('No se pudo obtener tu ubicación. Asegúrate de permitir el acceso a la ubicación.');
                  }
              );
          } else {
              alert('Tu navegador no soporta la geolocalización.');
          }
      }

      // Buscar recicladoras cercanas usando Google Places API
      function buscarRecicladorasCercanas(location) {
          const request = {
              location: location,
              radius: 10000, // Radio de búsqueda en metros
              keyword: 'recycling center'
          };

          service = new google.maps.places.PlacesService(map);
          service.nearbySearch(request, (results, status) => {
              const messageElement = document.querySelector(".text-muted");
              const loadMoreButton = document.getElementById("load-more-btn");

              if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                  currentResults = results;
                  messageElement.textContent = "¡Aquí están las recicladoras más cercanas!";
                  mostrarRecicladoras(); // Mostrar las primeras recicladoras
              } else {
                  messageElement.textContent = "No se encontraron recicladoras cercanas.";
                  loadMoreButton.disabled = true;
                  loadMoreButton.classList.add("disabled");
              }
          });
      }

      // Mostrar recicladoras en la vista
      function mostrarRecicladoras() {
          const recyclerList = document.getElementById('recycler-list');
          for (let i = resultsIndex; i < resultsIndex + resultsPerPage && i < currentResults.length; i++) {
              const place = currentResults[i];
              const card = document.createElement('div');
              card.className = 'card mb-4 shadow-sm recycler-card';
              card.innerHTML = `

                      <div class="col-sm-3" style="width:190px;">
                          <img src="${place.photos ? place.photos[0].getUrl() : '{% static "images/default.png" %}'}" style="width:100%;" class="img-fluid rounded-start" alt="Recicladora">
                      </div>

                          <div class="card-body col-md-9">
                              <h5 class="card-title">${place.name}</h5>
                              <p class="card-text text-muted">${place.vicinity}</p>
                              <button class="btn btn-contact" style="width:300px ;  " onclick="showCompanyInfo('${place.name}', '${place.vicinity}', '${place.geometry.location.lat()}, ${place.geometry.location.lng()}')">Encuentranos!</button>
                          </div>


              `;
              recyclerList.appendChild(card);
          }
          resultsIndex += resultsPerPage; // Incrementar el índice

          // Ocultar el botón si ya no hay más resultados
          if (resultsIndex >= currentResults.length) {
              document.getElementById('load-more-btn').style.display = 'none';
          }
      }

      // Evento para cargar más recicladoras al hacer clic en "Ver más"
      document.getElementById('load-more-btn').addEventListener('click', mostrarRecicladoras);

      function showCompanyInfo(name, address, coords) {
          // Asigna los valores proporcionados a los elementos del modal
          document.getElementById('companyName').innerText = name;
          document.getElementById('companyDescription').innerText = address;
          document.getElementById('companyLocation').innerText = "Ubicación: " + address;

          const [lat, lng] = coords.split(', ').map(Number);
          map.setCenter({ lat: lat, lng: lng });
          new google.maps.Marker({
              map: map,
              position: { lat: lat, lng: lng }
          });

          // Abre el modal
          var myModal = new bootstrap.Modal(document.getElementById('companyInfoModal'));
          myModal.show();
      }
  </script>

  <!-- Incluir el script de la API de Google Maps con Places API y async defer -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZWjlVC9wu6AvP-8TEx7vkbEVJpqRPLoE&libraries=places&callback=initMap"></script>
</main>
{% endblock %}
